type UserToken @entity(immutable: false) {
  id: Bytes! # account address,token address
  funds: BigInt!
  lockupCurrent: BigInt!
  lockupRate: BigInt!
  lockupLastSettledUntilEpoch: BigInt!
  lockupLastSettledUntilTimestamp: BigInt!
  payout: BigInt!
  fundsCollected: BigInt!
  account: Account!
  token: Token!
}

type Token @entity(immutable: false) {
  id: Bytes! # address
  name: String!
  symbol: String!
  decimals: BigInt!
  volume: BigInt!
  totalDeposits: BigInt!
  totalWithdrawals: BigInt!
  totalOneTimePayment: BigInt!
  totalSettledAmount: BigInt!
  totalUsers: BigInt!
  userFunds: BigInt! # same as sum of all UserToken.funds
  operatorCommission: BigInt!
  userTokens: [UserToken!]! @derivedFrom(field: "token")
}

type Account @entity(immutable: false) {
  id: Bytes! # address
  address: Bytes!
  totalRails: BigInt!
  totalTokens: BigInt!
  totalApprovals: BigInt!

  payerRails: [Rail!]! @derivedFrom(field: "payer")
  payeeRails: [Rail!]! @derivedFrom(field: "payee")
  operatorApprovals: [OperatorApproval!]! @derivedFrom(field: "client")
  userTokens: [UserToken!]! @derivedFrom(field: "account")
}

type OperatorApproval @entity(immutable: false) {
  id: Bytes! # client address,operator address,token address
  isApproved: Boolean!
  maxLockupPeriod: BigInt!
  lockupAllowance: BigInt!
  rateAllowance: BigInt!
  lockupUsage: BigInt!
  rateUsage: BigInt!

  client: Account!
  operator: Operator!
  token: Token!
}

type OperatorToken @entity(immutable: false) {
  id: Bytes! # operator address,token address
  commissionEarned: BigInt!
  volume: BigInt!
  lockupAllowance: BigInt!
  rateAllowance: BigInt!
  lockupUsage: BigInt!
  rateUsage: BigInt!
  settledAmount: BigInt!
  oneTimePaymentAmount: BigInt!

  operator: Operator!
  token: Token!
}

type Operator @entity(immutable: false) {
  id: Bytes! # address
  address: Bytes!
  totalRails: BigInt!
  totalTokens: BigInt!
  totalApprovals: BigInt!

  operatorTokens: [OperatorToken!]! @derivedFrom(field: "operator")
  rails: [Rail!]! @derivedFrom(field: "operator")
  operatorApprovals: [OperatorApproval!]! @derivedFrom(field: "operator")
}

enum RailState {
  ZERORATE
  ACTIVE
  TERMINATED
  FINALIZED
}

type Rail @entity(immutable: false) {
  id: Bytes! # railId
  railId: BigInt!
  paymentRate: BigInt!
  lockupFixed: BigInt!
  lockupPeriod: BigInt!
  settledUpto: BigInt!
  state: RailState!
  endEpoch: BigInt!
  arbiter: Bytes!
  commissionRateBps: BigInt!
  serviceFeeRecipient: Bytes!

  totalOneTimePaymentAmount: BigInt!
  totalSettledAmount: BigInt!
  # Fields that can be derived for a rail
  # 1. totalTransactedAmount = totalOneTimePaymentAmount + totalSettledAmount
  # 2. totalNetworkFees ( burned or auction ) = 0.5% of totalTransactedAmount
  # 3. totalCommissionEarned = commissionRateBps * (totalTransactedAmount - totalNetworkFees) / 10000
  # 4. totalNetPayeeAmount = totalTransactedAmount - totalNetworkFees - totalCommissionEarned
  # Similarly, networkFees, commissionEarned and netPayeeAmount can be calculated for oneTimePayments and rail settlements

  totalOneTimePayments: BigInt!
  totalSettlements: BigInt!
  totalRateChanges: BigInt!

  createdAt: BigInt!

  payer: Account!
  payee: Account!
  operator: Operator!
  token: Token!

  oneTimePayments: [OneTimePayment!]! @derivedFrom(field: "rail")
  settlements: [Settlement!]! @derivedFrom(field: "rail")
  rateChangeQueue: [RateChangeQueue!]! @derivedFrom(field: "rail")
}

type RateChangeQueue @entity(immutable: false) {
  id: Bytes! # railId,startEpoch
  startEpoch: BigInt!
  untilEpoch: BigInt!
  rate: BigInt!
  rail: Rail!
}

type Settlement @entity(immutable: true) {
  id: Bytes! # txHash + logIndex
  rail: Rail!
  totalSettledAmount: BigInt!
  totalNetPayeeAmount: BigInt!
  networkFee: BigInt!
  operatorCommission: BigInt!
  settledUpto: BigInt!

  txHash: Bytes!
  blockNumber: BigInt!
  createdAt: BigInt!
}

type OneTimePayment @entity(immutable: true) {
  id: Bytes! # txHash + logIndex
  rail: Rail!
  totalAmount: BigInt! # totalAmount = netPayeeAmount + operatorCommission + networkFee
  networkFee: BigInt! # networkFee = 0.5% of totalAmount
  operatorCommission: BigInt! # operatorCommission = (totalAmount - networkFee) * rail.commissionRateBps / 10000
  netPayeeAmount: BigInt! # netPayeeAmount = totalAmount - operatorCommission - networkFee
  txHash: Bytes!
  blockNumber: BigInt!
  createdAt: BigInt!
}

# Metrics

type PaymentsMetric @entity(immutable: false) {
  id: Bytes! # payments_network_stats
  totalRails: BigInt!
  totalOperators: BigInt!
  totalTokens: BigInt!
  totalAccounts: BigInt!
  totalFilBurned: BigInt!
  totalRailSettlements: BigInt!
  totalZeroRateRails: BigInt!
  totalActiveRails: BigInt!
  totalTerminatedRails: BigInt!
  totalFinalizedRails: BigInt!

  # Unique payers and payees
  uniquePayers: BigInt!
  uniquePayees: BigInt!
}

# Time-based metrics for analytics and graphs

type DailyMetric @entity(immutable: false) {
  id: Bytes! # timestamp (start of day in seconds)
  timestamp: BigInt!
  date: String! # YYYY-MM-DD format for easier querying
  # Volume metrics
  filBurned: BigInt!

  # Rail metrics
  railsCreated: BigInt!
  totalRailSettlements: BigInt!
  railsTerminated: BigInt!
  railsFinalized: BigInt!
  activeRailsCount: BigInt!

  # User metrics
  uniquePayers: BigInt!
  uniquePayees: BigInt!
  uniqueOperators: BigInt!
  uniqueAccounts: BigInt!
}

type WeeklyMetric @entity(immutable: false) {
  id: Bytes! # timestamp (start of week in seconds)
  timestamp: BigInt!
  week: BigInt! # week number
  # Volume metrics
  filBurned: BigInt!

  # Rail metrics
  railsCreated: BigInt!
  totalRailSettlements: BigInt!
  railsTerminated: BigInt!
  railsFinalized: BigInt!
  activeRailsCount: BigInt!

  # User metrics
  uniquePayers: BigInt!
  uniquePayees: BigInt!
  uniqueOperators: BigInt!
  uniqueAccounts: BigInt!
}

type DailyTokenMetric @entity(immutable: false) {
  id: Bytes! # token address + timestamp
  token: Token!
  timestamp: BigInt!
  date: String! # YYYY-MM-DD format
  # Token-specific volume
  volume: BigInt!
  deposit: BigInt!
  withdrawal: BigInt!
  oneTimePaymentAmount: BigInt!
  settledAmount: BigInt!
  commissionPaid: BigInt!

  # Token utilization
  activeRailsCount: BigInt!
  uniqueHolders: BigInt!
  totalLocked: BigInt!
}

type DailyOperatorMetric @entity(immutable: false) {
  id: Bytes! # operator address + timestamp
  operator: Operator!
  timestamp: BigInt!
  date: String! # YYYY-MM-DD format
  # Rail management
  railsCreated: BigInt!
  settlementsProcessed: BigInt!

  # Client metrics
  uniqueClients: BigInt!
  totalApprovals: BigInt!
}
